@page "/contact"
@using System.Text.Json
@using BlazorPortfolio.Models;
@using System.Globalization
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
<PageTitle>Jordy Schoolmeesters â€” Computing Science</PageTitle>

<div class="index gsap-animate-transition w-full relative">

   <div class="px-3 pt-[4rem] relative"> 

      <div class="">

         <div class="flex flex-col w-full">

            <div class="border-bottom h-[1px] w-full bg-black dark:bg-white"></div>

            <div class="py-3">

               <h1 class="about-first gsap-lines gsap-animate-transition text-2xl tracking-[-0.035em] leading-none">
                  <div class="gsap-line">
                     <div class="gsap-line-inner">
                        Let's work <span class="inferi-normal-italic">together</span>, what can
                     </div>
                  </div>
                  <div class="gsap-line">
                     <div class="gsap-line-inner">
                        I help you with?
                     </div>
                  </div>
               </h1>
            </div>
            @*<div class="border-bottom gsap-animate-transition h-[1px] w-full bg-black dark:bg-white"></div>*@

            <div class="gsap-line">
                  <h2 class="gsap-line-inner text-sm p-0 m-0 mt-6 mb-3 text-[rgb(145,145,145)]">Categories</h2>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="border h-24 flex items-center justify-center bg-[rgb(25,25,25)] border-none">
                    <span class="underline underline-offset-4 decoration-1 decoration-[rgb(145,145,145)] inline-block text-2xl leading-none align-middle inferi-normal">Webdesign</span>
                </div>
                <div class="border h-24 flex items-center justify-center bg-[rgb(25,25,25)] border-none">
                    <span class="underline underline-offset-4 decoration-1 decoration-[rgb(145,145,145)] inline-block text-2xl leading-none align-middle inferi-normal">Mixing</span>
                </div>
                <div class="border h-24 flex items-center justify-center bg-[rgb(25,25,25)] border-none">
                    <span class="underline underline-offset-4 decoration-1 decoration-[rgb(145,145,145)] inline-block text-2xl leading-none align-middle inferi-normal">Mastering</span>
                </div>
                <div class="border h-24 flex items-center justify-center bg-[rgb(25,25,25)] border-none">
                    <span class="underline underline-offset-4 decoration-1 decoration-[rgb(145,145,145)] inline-block text-2xl leading-none align-middle inferi-normal">Production</span>
                </div>
            </div>
         </div>

         <div class="mt-6 h-[30vh] w-full"><img class="object-cover object-center w-full h-full" src="@("/media/ice.jpg")"/></div>

         <footer class="py-6 flex flex-col">

            <div class="links gsap-animate-transition relative overflow-hidden">
               <BlazorPortfolio.Components.Links />
            </div>

         </footer>
      </div>
   </div>
</div>

@code {
   [Inject]
   private HttpClient HttpClient { get; set; }
   private List<Models.Post> Posts { get; set; } = new List<Models.Post>();
   private string SearchValue { get; set; } = String.Empty;
   private List<(Models.Post post, int i)> FilteredPosts
   {
      get
      {
         return Posts.Where(p => string.IsNullOrEmpty(SearchValue) ? true : p.Title.ToLower().Contains(SearchValue.ToLower()))
                                 .OrderByDescending(p => p.DateAsDateTime)
                                 .Take(3)
                                 .Select((post, i) => ( post, i ))
                                 .ToList();
      }
   }

   private (string, int)[] Tags = (new string[] { "All", "Project Updates", "Audio", "Webdesign", "Insights" }).Select((tag) => (tag, 0)).ToArray();

   protected override async Task OnAfterRenderAsync(bool firstRender)
   {
      await base.OnAfterRenderAsync(firstRender);

      if (firstRender) {
         await JS.InvokeVoidAsync("homeLoaded");
        
         while (FilteredPosts.Count == 0)
            await Task.Delay(100);
         bool result = await JS.InvokeAsync<bool>("waitForPosts", FilteredPosts.Count);

         if (result) {
            await JS.InvokeVoidAsync("animatePosts");
         }
      }
   }

   public async Task PostsLoaded() {
      await JS.InvokeVoidAsync("postsLoaded");
   }

   protected override async Task OnInitializedAsync()
   {
      var jsonContent = await HttpClient.GetStringAsync("posts/posts.json");
      var posts = JsonSerializer.Deserialize<List<Models.Post>>(jsonContent);
      if (posts != null) {
         Posts = posts;

         foreach (var post in Posts)
            Tags.Where(t => post.TagsAsList.Contains(t.Item1)).ToList()
                .ForEach(tag => { Tags[Array.IndexOf(Tags, tag)] = (tag.Item1, tag.Item2 + 1); Tags[0] = (Tags[0].Item1, Tags[0].Item2 + 1); });
      }
   }

   private async Task NavigateToPost(MouseEventArgs e, Models.Post post)
   {
      await JS.InvokeVoidAsync("beginTransitionBox", e.ClientX, e.ClientY);
      var baseUri = NavigationManager.BaseUri;
      NavigationManager.NavigateTo(Path.Combine(baseUri, "blog", "post", post.DateAsUriString, post.Id.Substring(post.Id.LastIndexOf('/') + 1)));
   }

   private void HandleInputChange(ChangeEventArgs e)
   {
      SearchValue = e.Value.ToString();
   }
}